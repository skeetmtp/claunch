# Claunch — Technical Specification

## Overview

Claunch is a macOS tool that registers the `claunch://` custom URL scheme. When a user clicks a
`claunch://` URL (e.g. in a browser, Slack, docs), it opens a Ghostty terminal window running
`claude` in interactive mode with the prompt from the URL.

**Status:** v0.1.0 — all core components implemented, ready for build + test on macOS.

## URL Scheme

```text
claunch://open?v=<version>&prompt=<url-encoded-prompt>&project=<name>
```

| Parameter | Required | Type   | Default | Description                                           |
| --------- | -------- | ------ | ------- | ----------------------------------------------------- |
| `v`       | yes      | int    | —       | URL scheme version number (currently only `1`)        |
| `prompt`  | yes      | string | —       | URL-encoded text passed as positional arg to `claude` |
| `project` | no       | string | —       | Project name; resolved from config or auto-discovered |

`project` is first looked up in the config file; if not found, auto-discovery scans
`~/.claude/projects/` (see [Project Auto-Discovery](#project-auto-discovery) below).

The scheme is `claunch`, the host is `open`. Any other host value is rejected. Standard URL
encoding applies — spaces as `+` or `%20`, quotes as `%22`, etc.

## Configuration

**Location:** `~/.config/claunch/config.json` (created manually or auto-generated by project discovery)

The config file is entirely optional — the app works without it. Project mappings are saved
automatically when auto-discovery resolves an unknown project name (see
[Project Auto-Discovery](#project-auto-discovery)).

```json
{
  "terminal": "ghostty",
  "projects": {
    "claunch": "/Users/alban/Developer/claude/claunch",
    "myapp": "/Users/alban/Developer/myapp"
  }
}
```

| Field      | Required | Type   | Description                                                        |
| ---------- | -------- | ------ | ------------------------------------------------------------------ |
| `terminal` | no       | string | `"ghostty"`, `"iterm"`, or `"terminal"`. Overrides fallback chain. |
| `projects` | no       | object | Map of short project names to absolute directory paths.            |

If `terminal` is set, only that terminal is used (no fallback; errors if unavailable). If omitted,
the default fallback chain applies (Ghostty → Terminal.app).

## Project Auto-Discovery

When `project=<name>` is used and the name is **not** in the config file, the handler automatically
scans `~/.claude/projects/` to find a matching directory. Claude Code stores per-project data in
this directory using encoded path names (e.g. `-Users-alban-work-lempire` encodes
`/Users/alban/work/lempire`).

**Resolution order:**

1. **Exact basename match** — directories whose last component equals the project name. If exactly
   one match exists, it is auto-selected with no dialog.
2. **Partial basename match** — directories whose last component contains the project name.
3. **All discovered projects** — if no basename match, all decoded projects are offered.

If multiple candidates exist (or no exact match), a macOS `choose from list` dialog is shown. The
selected mapping is saved to `~/.config/claunch/config.json` so future lookups are instant.

**Path decoding:** The encoded directory names use dashes as path separators, which is ambiguous
when path components contain dashes (e.g. `my-project`). The decoder recursively tries all
possible dash-to-slash split points, pruning with `os.path.isdir()` checks. The special sequence
`--` encodes a dot-prefixed component (e.g. `--meteor` decodes to `.meteor`).

**Edge cases:**

- `~/.claude/projects/` missing or empty → clear error message, no dialog
- User cancels the picker dialog → clean exit with error message
- No config file exists → created automatically with the new mapping
- Paths with special characters → safe via `osascript` argv passing (no shell interpolation)

## Architecture

Hybrid Swift + Python design. A thin Swift wrapper handles macOS URL scheme Apple Events (which
require a proper `.app` bundle and Cocoa event loop). All URL parsing and terminal launching logic
lives in Python, avoiding the need for PyObjC.

```text
macOS / Browser
    │
    │ claunch:// Apple Event
    v
Claunch (Swift) — NSApplication, delegates to Python
    │
    │ uv run handler.py <url>
    v
handler.py — parse URL, write script, launch terminal
```

## Components

### 1. Swift URL Event Handler — `src/claunch/app/main.swift`

**What it does:**

- Creates a minimal `NSApplication` with an `NSApplicationDelegate`
- Registers a handler for `kAEGetURL` Apple Events (the `kInternetEventClass` event that macOS
  sends when a registered URL scheme is opened)
- On URL event: extracts the URL string from the Apple Event descriptor, locates `handler.py` in
  `Bundle.main` Resources, spawns `uv run handler.py <url>` via `Process` (falls back to `python3`
  if `uv` is not installed)
- Terminates the app after the Python process completes

**Key implementation details:**

- Uses `keyDirectObject` to extract the URL from the event descriptor
- `Process.terminationHandler` dispatches termination back to the main queue
- Error paths (`guard let` failures) log via `NSLog` and terminate

**Size:** ~48 lines.

### 2. Info.plist — `src/claunch/app/Info.plist`

**What it does:**

- Declares the app bundle identity (`com.claunch.urlhandler`)
- Registers the `claunch` URL scheme via `CFBundleURLTypes`
- Sets `LSBackgroundOnly = true` so the app doesn't appear in the Dock

**Key fields:**

| Key                  | Value                    | Purpose                  |
| -------------------- | ------------------------ | ------------------------ |
| `CFBundleIdentifier` | `com.claunch.urlhandler` | Unique bundle ID         |
| `CFBundleExecutable` | `Claunch`                | Binary name in MacOS/    |
| `LSBackgroundOnly`   | `true`                   | No dock icon             |
| `CFBundleURLSchemes` | `["claunch"]`            | Registers the URL scheme |

### 3. Python Handler — `src/claunch/handler.py`

**What it does:**

- Accepts the full `claunch://` URL as `sys.argv[1]`
- Parses with `urllib.parse.urlparse` + `parse_qs`
- Validates: scheme must be `claunch`, host must be `open`, prompt must be non-empty
- For unknown `project` names, auto-discovers from `~/.claude/projects/`, shows a picker if
  needed, and saves the mapping to config
- Constructs the claude command with `shlex.quote` escaping
- Writes a temporary launcher shell script (`/tmp/claunch_XXXX.sh`) containing `cd <project-dir>`
  and `exec claude <prompt>`
- Attempts to launch Ghostty, falls back to Terminal.app

**Functions:**

| Function                   | Description                                            |
| -------------------------- | ------------------------------------------------------ |
| `load_config`              | Read + validate config JSON                            |
| `decode_project_dir`       | Decode a `~/.claude/projects/` dirname to paths        |
| `discover_claude_projects` | Scan `~/.claude/projects/`, return decoded path map    |
| `show_project_picker`      | macOS `choose from list` dialog for project selection  |
| `save_project_mapping`     | Save a project→directory mapping to config (atomic)    |
| `resolve_unknown_project`  | Orchestrator: discover → filter → pick → save          |
| `parse_url`                | Parse/validate URL, resolve project, return 3-tuple    |
| `write_temp_script`        | Write temp `.sh` script, return path                   |
| `launch_ghostty`           | Try Ghostty CLI then `open -a`                         |
| `launch_iterm`             | Launch iTerm2 via osascript                            |
| `launch_terminal_app`      | Fallback via `osascript` + Terminal                    |
| `launch_in_terminal`       | Route to configured terminal                           |
| `main`                     | Entry point: parse, build, launch                      |

**Terminal launching strategy:**

If `terminal` is set in the config file, only that terminal is used (error if unavailable).
Otherwise the default fallback chain applies:

1. **Ghostty (primary):** Check if `ghostty` CLI is on PATH. If so, use
   `ghostty +new-window --command=<script>`. If the CLI isn't available but
   `/Applications/Ghostty.app` exists, fall back to
   `open -na Ghostty.app --args --command=<script>`.
2. **iTerm2 (config only):** If configured, use
   `osascript -e 'tell application "iTerm2" to create window with default profile command "<script>"'`.
   Requires `/Applications/iTerm.app`.
3. **Terminal.app (fallback):** Use
   `osascript -e 'tell application "Terminal" to do script "<command>"'`.

The temp script approach avoids issues with `open -na Ghostty.app --args -e` (tab duplication and
login wrapper problems on macOS).

**Security:** All user-supplied strings (prompt, directory) are escaped with `shlex.quote` before
being embedded in shell commands.

### 4. Build Script — `build.py`

**What it does:**

1. Cleans any existing `Claunch.app` directory
2. Creates `Claunch.app/Contents/{MacOS,Resources}` structure
3. Compiles Swift:
   `swiftc -o Claunch.app/Contents/MacOS/Claunch src/claunch/app/main.swift`
4. Copies `Info.plist` to `Claunch.app/Contents/`
5. Copies `handler.py` to `Claunch.app/Contents/Resources/`
6. Sets executable permissions on the binary

**Requirements:** `swiftc` (Xcode Command Line Tools).

### 5. Install Script — `install.sh`

**What it does:**

1. Verifies `Claunch.app` exists (errors if not built yet)
2. Creates `~/Applications/` if needed
3. Removes any previous `Claunch.app` installation
4. Copies the built `.app` bundle to `~/Applications/`
5. Registers with Launch Services via `lsregister -R`
6. Verifies registration by checking `lsregister -dump` for `claunch`

## File Inventory

| File                         | Language | Lines | Status |
| ---------------------------- | -------- | ----- | ------ |
| `pyproject.toml`             | TOML     | 13    | Done   |
| `src/claunch/__init__.py`    | Python   | 1     | Done   |
| `src/claunch/handler.py`     | Python   | 396   | Done   |
| `src/claunch/app/main.swift` | Swift    | 48    | Done   |
| `src/claunch/app/Info.plist` | XML      | 33    | Done   |
| `build.py`                   | Python   | 60    | Done   |
| `install.sh`                 | Bash     | 46    | Done   |

## Built App Bundle Structure

```text
Claunch.app/
└── Contents/
    ├── Info.plist               # Copied from src/claunch/app/Info.plist
    ├── MacOS/
    │   └── Claunch              # Compiled from src/claunch/app/main.swift
    └── Resources/
        └── handler.py           # Copied from src/claunch/handler.py
```

## Dependencies

| Dependency                        | Type               | Purpose                                           |
| --------------------------------- | ------------------ | ------------------------------------------------- |
| [uv](https://docs.astral.sh/uv/)  | Build + Runtime    | Runs Python scripts; manages Python automatically |
| swiftc                            | Build-time         | Compile main.swift                                |
| Ghostty                           | Runtime (optional) | Primary terminal emulator                         |
| iTerm2                            | Runtime (optional) | Alternative terminal (config only)                |
| Terminal.app                      | Runtime (fallback) | Fallback terminal                                 |
| claude CLI                        | Runtime            | The tool being launched                           |

Zero external Python packages. The handler uses only stdlib: `json`, `os`, `shlex`, `subprocess`,
`sys`, `tempfile`, `urllib.parse`.

## Verification Checklist

| #   | Test              | Command                                             | Expected                            |
| --- | ----------------- | --------------------------------------------------- | ----------------------------------- |
| 1   | Build             | `uv run build.py`                                   | Produces `Claunch.app/` with bin    |
| 2   | Install           | `bash install.sh`                                   | Copies to `~/Applications/`         |
| 3   | Basic prompt      | `open 'claunch://open?v=1&prompt=hello+world'`      | Ghostty opens, claude starts        |
| 4   | URL encoding      | See note below                                      | Prompt: `fix the bug in "main.py"`  |
| 5   | Missing prompt    | `open 'claunch://open?v=1'`                         | Error logged, no terminal opens     |
| 6   | Terminal fallback | Uninstall Ghostty, repeat test 3                    | Terminal.app opens instead          |
| 7   | Project param     | `open 'claunch://open?v=1&prompt=hi&project=test'`  | Opens in project directory          |
| 8   | Auto-discover     | `open '...?v=1&prompt=hi&project=claunch'`          | Auto-resolves, saved to config      |
| 9   | Discover picker   | `open '...?v=1&prompt=hi&project=rc'`               | Picker dialog, user selects         |
| 10  | Cancel picker     | Cancel dialog from test 9                           | Clean exit, no terminal opens       |
| 11  | No projects dir   | `open '...?v=1&prompt=hi&project=nope'`             | Error if no `~/.claude/projects/`   |
| 12  | Re-run after save | Repeat test 8                                       | Uses config directly (no discovery) |
| 13  | No config         | Remove config file, repeat test 3                   | Current behavior (Ghostty fallback) |
| 14  | Terminal config   | Set `"terminal": "terminal"`, repeat test 3         | Terminal.app opens                  |
| 15  | iTerm config      | Set `"terminal": "iterm"`, repeat test 3            | iTerm2 opens                        |

Test 4 command: `open 'claunch://open?v=1&prompt=fix%20the%20bug%20in%20%22main.py%22'`
Test 7 setup: `mkdir -p ~/.config/claunch && echo '{"projects":{"test":"/tmp"}}' > ~/.config/claunch/config.json`
Test 8 setup: remove `claunch` from config `projects` if present

## What's Not Yet Done

- **No automated tests** — handler.py functions are testable but no test suite exists yet
- **No icon** — the app bundle has no `AppIcon.icns`
- **No code signing** — the binary is unsigned (fine for local use, would need signing for
  distribution)
- **No Homebrew formula / installer package** — manual build + install only
- **Ghostty launch strategy not validated on hardware** — the `+new-window --command=` approach
  and the `open -na` fallback need testing on an actual Mac to confirm which path works; the
  handler tries both
- **Temp script cleanup** — launcher scripts in `/tmp` are not cleaned up after use

## Notes

You can test the Ghostty launch strategy with:

```bash
open -na ghostty --args --title=ghostty-from-vscode --working-directory="$(pwd)" --initial-window --fullscreen
```
